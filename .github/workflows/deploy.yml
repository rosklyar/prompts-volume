name: Deploy to Azure

on:
  workflow_dispatch:
    inputs:
      deploy_backend:
        description: 'Deploy backend'
        type: boolean
        default: true
      deploy_frontend:
        description: 'Deploy frontend'
        type: boolean
        default: true

concurrency:
  group: production-deploy
  cancel-in-progress: false

env:
  ACR_NAME: promptsacr
  RESOURCE_GROUP: prompts-rg
  CONTAINER_APP_NAME: prompts-backend
  BACKEND_URL: https://prompts-backend.jollydune-754acd02.canadacentral.azurecontainerapps.io

jobs:
  # Job 1: Wait for Backend CI (conditional)
  wait-for-backend-ci:
    if: ${{ inputs.deploy_backend }}
    runs-on: ubuntu-latest
    steps:
      - name: Wait for Backend CI
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.sha }}
          check-name: 'backend-test'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10

  # Job 2: Wait for Frontend CI (conditional)
  wait-for-frontend-ci:
    if: ${{ inputs.deploy_frontend }}
    runs-on: ubuntu-latest
    steps:
      - name: Wait for Frontend CI
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.sha }}
          check-name: 'frontend-test'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10

  # Job 3: Bump backend version and create tag
  version-backend:
    if: ${{ inputs.deploy_backend }}
    needs: wait-for-backend-ci
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.bump.outputs.version }}
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump Backend Version
        id: bump
        run: |
          CURRENT_VERSION=$(cat backend/VERSION 2>/dev/null || echo "0.1.0")
          MAJOR=$(echo $CURRENT_VERSION | cut -d. -f1)
          MINOR=$(echo $CURRENT_VERSION | cut -d. -f2)
          PATCH=$(echo $CURRENT_VERSION | cut -d. -f3)
          NEW_VERSION="$MAJOR.$MINOR.$((PATCH + 1))"

          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Bumping backend: $CURRENT_VERSION -> $NEW_VERSION"

          # Update backend VERSION file
          echo "$NEW_VERSION" > backend/VERSION

          # Update backend pyproject.toml
          sed -i "s/^version = \".*\"/version = \"$NEW_VERSION\"/" backend/pyproject.toml

      - name: Commit and Tag Backend
        run: |
          git add backend/VERSION backend/pyproject.toml
          git commit -m "chore: bump backend version to v${{ steps.bump.outputs.version }} [skip ci]"
          git push
          git tag -a "backend-v${{ steps.bump.outputs.version }}" -m "Backend Release v${{ steps.bump.outputs.version }}"
          git push origin "backend-v${{ steps.bump.outputs.version }}"

  # Job 4: Bump frontend version and create tag
  version-frontend:
    if: ${{ inputs.deploy_frontend }}
    needs: wait-for-frontend-ci
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.bump.outputs.version }}
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Pull latest changes
        run: git pull --rebase origin ${{ github.ref_name }}

      - name: Bump Frontend Version
        id: bump
        run: |
          CURRENT_VERSION=$(cat frontend/VERSION 2>/dev/null || echo "0.1.0")
          MAJOR=$(echo $CURRENT_VERSION | cut -d. -f1)
          MINOR=$(echo $CURRENT_VERSION | cut -d. -f2)
          PATCH=$(echo $CURRENT_VERSION | cut -d. -f3)
          NEW_VERSION="$MAJOR.$MINOR.$((PATCH + 1))"

          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Bumping frontend: $CURRENT_VERSION -> $NEW_VERSION"

          # Update frontend VERSION file
          echo "$NEW_VERSION" > frontend/VERSION

          # Update frontend package.json
          cd frontend && npm version $NEW_VERSION --no-git-tag-version --allow-same-version

      - name: Commit and Tag Frontend
        run: |
          git add frontend/VERSION frontend/package.json
          git commit -m "chore: bump frontend version to v${{ steps.bump.outputs.version }} [skip ci]"
          git push
          git tag -a "frontend-v${{ steps.bump.outputs.version }}" -m "Frontend Release v${{ steps.bump.outputs.version }}"
          git push origin "frontend-v${{ steps.bump.outputs.version }}"

  # Job 5: Deploy Backend
  deploy-backend:
    if: ${{ inputs.deploy_backend }}
    needs: version-backend
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4
        with:
          ref: backend-v${{ needs.version-backend.outputs.version }}

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to ACR
        run: az acr login --name ${{ env.ACR_NAME }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: |
            ${{ env.ACR_NAME }}.azurecr.io/prompts-backend:v${{ needs.version-backend.outputs.version }}
            ${{ env.ACR_NAME }}.azurecr.io/prompts-backend:latest
            ${{ env.ACR_NAME }}.azurecr.io/prompts-backend:sha-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy to Container Apps
        run: |
          az containerapp update \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.ACR_NAME }}.azurecr.io/prompts-backend:v${{ needs.version-backend.outputs.version }} \
            --set-env-vars \
              DATABASE_URL="${{ secrets.DATABASE_URL }}" \
              USERS_DATABASE_URL="${{ secrets.USERS_DATABASE_URL }}" \
              EVALS_DATABASE_URL="${{ secrets.EVALS_DATABASE_URL }}" \
              OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
              DATAFORSEO_USERNAME="${{ secrets.DATAFORSEO_USERNAME }}" \
              DATAFORSEO_PASSWORD="${{ secrets.DATAFORSEO_PASSWORD }}" \
              SECRET_KEY="${{ secrets.SECRET_KEY }}" \
              FIRST_SUPERUSER_EMAIL="${{ secrets.FIRST_SUPERUSER_EMAIL }}" \
              FIRST_SUPERUSER_PASSWORD="${{ secrets.FIRST_SUPERUSER_PASSWORD }}" \
              FRONTEND_URL="https://app.tryllmhero.com" \
              EVALUATION_API_TOKENS="${{ secrets.EVALUATION_API_TOKENS }}" \
              TOPICS_PROVIDER_SIMILARITY_THRESHOLD="0.8" \
              BREVO_API_KEY="${{ secrets.BREVO_API_KEY }}"

      - name: Health Check
        run: |
          echo "Waiting 30s for deployment..."
          sleep 30
          APP_URL=$(az containerapp show --name ${{ env.CONTAINER_APP_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --query "properties.configuration.ingress.fqdn" -o tsv)
          for i in {1..5}; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://$APP_URL/health" || true)
            [ "$HTTP_STATUS" = "200" ] && echo "Health check passed!" && exit 0
            echo "Attempt $i: HTTP $HTTP_STATUS - retrying..."
            sleep 10
          done
          exit 1

  # Job 6: Deploy Frontend
  deploy-frontend:
    if: ${{ inputs.deploy_frontend }}
    needs: version-frontend
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4
        with:
          ref: frontend-v${{ needs.version-frontend.outputs.version }}

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Build Frontend
        working-directory: ./frontend
        run: |
          npm ci
          npx @tanstack/router-cli generate
          npm run build
        env:
          VITE_API_URL: ${{ env.BACKEND_URL }}

      - name: Deploy to Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "/frontend/dist"
          output_location: ""
          skip_app_build: true

  # Job 7: Create GitHub Release
  release:
    if: ${{ always() && (needs.deploy-backend.result == 'success' || needs.deploy-frontend.result == 'success') }}
    needs: [version-backend, version-frontend, deploy-backend, deploy-frontend]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create Backend Release
        if: ${{ needs.deploy-backend.result == 'success' }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: backend-v${{ needs.version-backend.outputs.version }}
          name: Backend v${{ needs.version-backend.outputs.version }}
          generate_release_notes: true

      - name: Create Frontend Release
        if: ${{ needs.deploy-frontend.result == 'success' }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: frontend-v${{ needs.version-frontend.outputs.version }}
          name: Frontend v${{ needs.version-frontend.outputs.version }}
          generate_release_notes: true
